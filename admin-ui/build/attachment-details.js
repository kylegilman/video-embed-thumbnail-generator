(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.i18n,r=window.wp.apiFetch;var n=e.n(r);const a=window.wp.components,s=(window.wp.compose,window.wp.coreData),o=window.wp.element,i=window.ReactJSXRuntime,c=window.wp.blockEditor,l=window.wp.mediaUtils,d=window.wp.url,u=window.wp.primitives,m=(0,i.jsx)(u.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,i.jsx)(u.Path,{d:"M6.5 12.4L12 8l5.5 4.4-.9 1.2L12 10l-4.5 3.6-1-1.2z"})}),p=(0,i.jsx)(u.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,i.jsx)(u.Path,{d:"M17.5 11.6L12 16l-5.5-4.4.9-1.2L12 14l4.5-3.6 1 1.2z"})}),h=({setAttributes:e,attributes:r,attachmentRecord:s,options:u})=>{const{id:h,numberofthumbs:_,src:f,poster:g,poster_id:b}=r,v=(0,o.useRef)(),j=(0,o.useRef)(),k=(0,o.useRef)(),w=(0,o.useRef)(),[y,x]=(0,o.useState)(!1),[R,N]=(0,o.useState)(!1),[E,C]=(0,o.useState)(!1),[S,I]=(0,o.useState)([]),[T,O]=(0,o.useState)(!1),B="/videopack/v1/thumbs";(0,o.useEffect)(()=>{g||j.current.on("loadedmetadata",()=>{D("generate")})},[j.current]);const D=async(e="generate")=>{if(O(!0),u?.ffmpeg_exists&&!u?.browser_thumbnails){const t=[];let r=0,n=0;for(let a=1;a<=Number(_);a++){n=a+r;const s=await U(a,n,e);r++,console.log(s);let o={src:s.real_thumb_url,type:"ffmpeg",thumb_url:s.thumb_url};t.push(o),I([...t])}O(!1)}else L(e)},L=(0,o.useCallback)(async e=>{const t=Number(_),r=[],n=[...Array(t)].map((r,n)=>{let a=(n+1)/(t+1)*j.current.duration;if("random"===e){const e=Math.floor(Math.random()*(j.current.duration/t));a=Math.max(a-e,0)}return a}),a=()=>{let e;A().then(s=>{try{e={src:s.toDataURL(),type:"canvas"}}catch(e){return console.error(e),j.current.removeEventListener("timeupdate",a),void O(!1)}r.push(e),I([...r]),r.length===t?(j.current.removeEventListener("timeupdate",a),O(!1)):j.current.currentTime=n[r.length]}).catch(e=>{console.error("Error processing canvas:",e)})};j.current.addEventListener("timeupdate",a),j.current.currentTime=n[0]}),q=()=>{j.current?.paused?(j.current.play(),x(!0)):(j.current?.pause(),x(!1))},M=()=>{j.current.pause(),x(!1)};(0,o.useEffect)(()=>{const e=()=>{C(j.current.currentTime)};return j.current?.addEventListener("timeupdate",e),()=>{j.current?.removeEventListener("timeupdate",e)}},[]);const A=async()=>{const e=document.createElement("canvas");if(e.width=j.current.videoWidth,e.height=j.current.videoHeight,e.getContext("2d").drawImage(j.current,0,0,e.width,e.height),!u?.ffmpeg_thumb_watermark?.url)return e;try{const r=function(e){return new Promise(async(r,n)=>{try{u?.ffmpeg_thumb_watermark?.url||n(new Error("No thumbnail watermark set"));const a=e.getContext("2d"),s=new Image,{url:o,scale:i,align:c,x:l,valign:d,y:m}=u.ffmpeg_thumb_watermark;s.crossOrigin="Anonymous",s.src=o,s.onload=()=>{const o=e.width,u=e.height,p=o*i/100,h=u*i/100,_=o*l/100,f=u*m/100;let g,b;switch(c){case"left":g=_;break;case"center":g=(o-p)/2+_;break;case"right":g=o-p-_;break;default:return void n(new Error((0,t.__)("Invalid horizontal alignment provided")))}switch(d){case"top":b=f;break;case"center":b=(u-h)/2+f;break;case"bottom":b=u-h-f;break;default:return void n(new Error((0,t.__)("Invalid vertical alignment provided")))}a.drawImage(s,g,b,p,h),r(e)},s.onerror=()=>{n(new Error((0,t.__)("Failed to load watermark image")))}}catch(e){n(e)}})}(e);return r}catch(e){console.error("Error drawing watermark:",e)}},P=async(e,r)=>{const n=(0,d.getFilename)(f),a=n.substring(0,n.lastIndexOf("."))||n;try{const n=(e=>{const t=atob(e.split(",")[1]),r=new ArrayBuffer(t.length),n=new Uint8Array(r);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return r})(e),o=new File([n],a+"_thumb"+(r+1)+".png",{type:"image/png"});O(!0);const i=await(s={filesList:[o],allowedTypes:["image/png"],title:a+" "+(0,t.__)("thumbnail")+" "+(r+1)},new Promise((e,t)=>{(0,l.uploadMedia)({...s,onFileChange:t=>{const r=t[0];r&&r.hasOwnProperty("id")&&e(r)},onError:e=>{t(e)}})}));F(i.url,i.id),O(!1)}catch(e){console.error((0,t.__)("Upload error:"),e),createErrorNotice(e,{type:"snackbar"})}var s},F=(t,r)=>{e({poster:t,poster_id:r}),I([]),s.edit({featured_media:Number(r),meta:{"_kgflashmediaplayer-poster":t,"_kgflashmediaplayer-poster-id":Number(r)}}).then(e=>{s.save().then(e=>{console.log(s)})}).catch(e=>{console.error(e)})},U=async(e,t,r)=>{try{const a=(0,d.addQueryArgs)(B,{url:f,numberofthumbs:_,thumbnumber:e,thumbnumberplusincreaser:t,attachmentID:h,generate_button:r,thumbtimecode:0,dofirstframe:!1,poster:g});return await n()({path:a})}catch(e){console.error(e)}},$=e=>{switch(e.stopImmediatePropagation(),e.code){case"Space":q();break;case"ArrowLeft":M(),j.current.currentTime=j.current.currentTime-.042;break;case"ArrowRight":M(),j.current.currentTime=j.current.currentTime+.042;break;case"KeyJ":y&&(j.current.playbackRate=Math.max(0,j.current.playbackRate-1));break;case"KeyK":M();break;case"KeyL":y&&(j.current.playbackRate=j.current.playbackRate+1),j.current.play(),x(!0);break;default:return}e.preventDefault()};return(0,i.jsx)("div",{className:"videopack-thumbnail-generator",children:(0,i.jsxs)(a.PanelBody,{title:(0,t.__)("Thumbnails"),children:[g&&(0,i.jsx)("img",{className:"videopack-current-thumbnail",src:g,ref:k}),(0,i.jsxs)(a.BaseControl,{className:"editor-video-poster-control",children:[(0,i.jsx)(a.BaseControl.VisualLabel,{children:(0,t.__)("Video Thumbnail")}),(0,i.jsx)(c.MediaUpload,{title:(0,t.__)("Select video thumbnail"),onSelect:function(t){e({poster:t.url,poster_id:Number(t.id)})},allowedTypes:["image"],render:({open:e})=>(0,i.jsx)(a.Button,{variant:"secondary",onClick:e,ref:w,children:g?(0,t.__)("Replace"):(0,t.__)("Select")})}),!!g&&(0,i.jsx)(a.Button,{onClick:function(){e({poster:void 0}),w.current.focus()},variant:"tertiary",children:(0,t.__)("Remove")})]}),(0,i.jsx)(a.TextControl,{value:_,onChange:t=>{e(t?{numberofthumbs:Number(t)}:{numberofthumbs:""})},className:"videopack-numberofthumbs",disabled:T}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>D("generate"),className:"videopack-generate",disabled:T,children:(0,t.__)("Generate")}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>D("random"),className:"videopack-generate",disabled:T,children:(0,t.__)("Random")}),S.length>0&&(0,i.jsx)("div",{className:"videopack-thumbnail-holder"+(T?" disabled":""),children:S.map((e,r)=>(0,i.jsxs)("div",{className:"videopack-thumbnail",onClick:t=>{((e,t,r)=>{e.currentTarget.classList.add("saving"),O(!0),"ffmpeg"===t.type?(async(e,t)=>{try{const r=await n()({path:B,method:"PUT",data:{post_id:h,thumburl:e,index:t}});F(r.thumb_url,r.thumb_id)}catch(e){console.error(e)}})(t.thumb_url,r):P(t.src,r)})(t,e,r)},children:[(0,i.jsx)("img",{src:e.src,alt:`Thumbnail ${r+1}`,title:(0,t.__)("Save and set thumbnail")}),(0,i.jsx)(a.Spinner,{})]},r))}),(0,i.jsxs)("div",{className:"components-panel__body videopack-thumb-video "+(R?"is-opened":""),children:[(0,i.jsx)("h2",{className:"components-panel__body-title",children:(0,i.jsxs)("button",{className:"components-button components-panel__body-toggle",type:"button",onClick:e=>{e.preventDefault();const t=!R;N(t),t&&v.current?(v.current.focus(),v.current.addEventListener("keydown",$)):v.current.addEventListener("keydown",$)},"aria-expanded":R,children:[(0,i.jsx)("span",{"aria-hidden":"true",children:(0,i.jsx)(a.Icon,{className:"components-panel__arrow",icon:R?m:p})}),(0,t.__)("Choose From Video")]})}),(0,i.jsxs)("div",{className:"videopack-thumb-video-panel",tabIndex:0,ref:v,children:[(0,i.jsx)("video",{src:f,ref:j,muted:!0,preload:"metadata",onClick:q}),(0,i.jsx)(a.Button,{className:"videopack-play-pause",onClick:q,children:(0,i.jsx)(a.Dashicon,{icon:y?"controls-pause":"controls-play"})}),!isNaN(j.current?.duration)&&(0,i.jsx)(a.RangeControl,{__nextHasNoMarginBottom:!0,min:0,max:j.current.duration,step:"any",initialPosition:0,value:j.current.currentTime,onChange:e=>{j.current.currentTime=e,C(e)},className:"videopack-thumbvideo-slider",type:"slider"}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>{O(!0);const e=A();P(e.toDataURL(),0)},disabled:T,children:(0,t.__)("Use this frame")})]})]})]})})},_=window.wp.data,f=({setAttributes:e,attributes:r,attachmentRecord:s,options:l})=>{const{id:d,src:u,height:m}=r,{ffmpeg_exists:p}=l,[h,f]=(0,o.useState)(),[g,b]=(0,o.useState)(),[v,j]=(0,o.useState)(null),[k,w]=(0,o.useState)(null),[y,x]=(0,o.useState)(!1),[R,N]=(0,o.useState)(!1),[E,C]=(0,o.useState)(!1),S=(0,o.useRef)(null),I=(0,o.useRef)(null),T="/videopack/v1/queue",O=()=>{d&&n()({path:"/videopack/v1/formats/"+d}).then(e=>{if(f(e),e&&"object"==typeof e){const t={...e};Object.keys(t).forEach(e=>{t[e]&&void 0===t[e].checked&&(t[e].checked=!1)}),f(t)}})};(0,o.useEffect)(()=>{O()},[d]);const B=e=>!!(!1===e||null===e||Array.isArray(e)&&0===e.length||"object"==typeof e&&0===Object.keys(e).length),D=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const a of r)if(!n.includes(a)||!D(e[a],t[a]))return!1;return!0},L=(0,_.useSelect)(e=>e("core").getSite(),[]),q=()=>{if(console.log("progress"),E){const e=Object.entries(h).reduce((e,[t,r])=>{if(B(r.progress))e[t]=r;else{const n=r.progress.current_seconds+parseInt(r.progress.fps)/30;let a=Math.round(r.progress.current_seconds/parseInt(r.progress.duration)*100);a>100&&(a=100),0!=a&&(r.progress.elapsed=r.progress.elapsed+1,isNaN(r.progress.remaining)||(r.progress.remaining>0?r.progress.remaining--:r.progress.remaing=0)),e[t]={...r,progress:{...r.progress,current_seconds:n,elapsed:r.progress.elapsed,percent_done:a,remaining:r.progress.remaining}}}return e},{});f(e)}},M=()=>{console.log("update"),u&&d&&n()({path:"/videopack/v1/formats/"+d,method:"GET"}).then(e=>{D(h,e)||f(e)}).catch(e=>console.error("Error polling video formats:",e))};(0,o.useEffect)(()=>(C(!!h&&Object.values(h).some(e=>e.hasOwnProperty("encoding_now")&&e.encoding_now)),S.current=setTimeout(M,5e3),E?(null===I.current&&(I.current=setInterval(q,1e3)),()=>{null!==I.current&&(clearInterval(I.current),I.current=null),null!==S.current&&(clearTimeout(S.current),S.current=null)}):(clearInterval(I.current),void(I.current=null))),[h,E]);const A=e=>{console.log("select")},P=e=>{if(!e)return b((0,t.__)("Error: Cannot delete job, missing job ID.")),void console.error("Cannot delete job: Missing job ID");w(e),n()({path:`${T}/${e}`,method:"DELETE"}).then(e=>{b((0,t.__)("Job cancelled/deleted successfully.")),O()}).catch(e=>{console.error("Job delete failed:",e),b((0,t.sprintf)((0,t.__)("Error deleting job: %s"),e.message)),O()}).finally(()=>{w(null)})},F=(e,t)=>{const r=h?.[t];r&&(j({type:e,formatId:t,jobId:r.job_id,childId:r.child_id,name:r.name}),x(!0))},U=e=>{if(null==e||isNaN(e))return"--:--";const t=e=>Math.floor(e).toString().padStart(2,"0"),r=Math.floor(e/3600),n=Math.floor(e%3600/60),a=Math.floor(e%60);return(r>0?t(r)+":":"")+t(n)+":"+t(a)},$=({format:e})=>{const r=h?.[e];if("processing"===r?.status&&!B(r?.progress)){const e=(0,t.sprintf)((0,t.__)("%d%%"),r.progress.percent_done),n=()=>{r.job_id&&P(r.job_id)};return(0,i.jsxs)("div",{className:"videopack-encode-progress",children:[(0,i.jsx)("div",{className:"videopack-meter",children:(0,i.jsx)("div",{className:"videopack-meter-bar",style:{width:e},children:(0,i.jsx)("div",{className:"videopack-meter-text",children:r.progress.percent_done>20&&e})})}),r.job_id&&(0,i.jsx)(a.Button,{onClick:n,variant:"secondary",isDestructive:!0,size:"small",isBusy:k===r.job_id,children:(0,t.__)("Cancel")}),(0,i.jsxs)("div",{className:"videopack-encode-progress-small-text",children:[(0,i.jsx)("span",{children:(0,t.__)("Elapsed:")+" "+U(r.progress.elapsed)}),(0,i.jsx)("span",{children:(0,t.__)("Remaining:")+" "+U(r.progress.remaining)}),(0,i.jsx)("span",{children:(0,t.__)("fps:")+" "+r.progress.fps})]})]})}return"failed"!==r?.status||B(r?.error_message)?null:(0,i.jsxs)("div",{className:"videopack-encode-error",children:[(0,t.sprintf)((0,t.__)("Error: %s"),r.error_message),r.job_id&&(0,i.jsx)(a.Button,{onClick:()=>F("job",e),variant:"link",text:(0,t.__)("Delete Job"),isDestructive:!0,isBusy:k===r.job_id})]})},z=()=>!!h&&Object.values(h).some(e=>e.checked&&e.is_available&&"queued"!==e.status&&"processing"!==e.status&&"completed"!==e.status&&"pending_replacement"!==e.status),J=(()=>{if(!h)return{};let e={...h};if(l.hide_video_formats&&l.encode&&(e=Object.fromEntries(Object.entries(e).filter(([e,t])=>!0===l.encode[e]||"not_queued"!==t.status))),s?.record?.media_details?.height){const t=s.record.media_details.height;e=Object.fromEntries(Object.entries(e).filter(([e,r])=>!r.height||r.height<=t||!0===r.replaces_original))}return e})(),V=R||!p||!z();return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.PanelBody,{title:(0,t.__)("Additional Formats"),children:(0,i.jsxs)(c.MediaUploadCheck,{children:[(0,i.jsx)(a.PanelRow,{children:h?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("ul",{className:"videopack-formats-list"+(p?"":" no-ffmpeg"),children:Object.keys(J).map(e=>{const r=J[e];if(!r)return null;const n=!p||!r.is_available||"not_queued"!==r.status;return(0,i.jsxs)("li",{children:[p&&r.is_available&&"not_queued"===r.status?(0,i.jsx)(a.CheckboxControl,{__nextHasNoMarginBottom:!0,className:"videopack-format",label:r.name,checked:r.checked,disabled:n,onChange:t=>((e,t)=>{f(r=>{const n={...r};return n[t]&&(n[t].checked=e),n})})(t,e)}):(0,i.jsx)("span",{className:"videopack-format",children:r.name}),"not_queued"!==r.status&&(0,i.jsx)("span",{className:"videopack-format-status",children:r.status_l10n}),r.exists&&"not_queued"===r.status&&!r.was_picked&&(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>A(),className:"videopack-format-button",size:"small",title:(0,t.__)("Link existing file"),children:(0,t.__)("Link")}),r.was_picked&&(0,i.jsx)(c.MediaUpload,{title:(0,t.sprintf)((0,t.__)("Replace %s"),r.name),onSelect:A,allowedTypes:["video"],render:({open:e})=>(0,i.jsx)(a.Button,{variant:"secondary",onClick:e,className:"videopack-format-button",size:"small",title:(0,t.__)("Replace file"),children:(0,t.__)("Replace")})}),r.deletable&&r.child_id&&(0,i.jsx)(a.Button,{isBusy:k===e,onClick:()=>F("file",e),variant:"link",text:(0,t.__)("Delete File"),isDestructive:!0}),("processing"===r.status||"failed"===r.status)&&(0,i.jsx)($,{format:e}),(0,i.jsx)(a.__experimentalDivider,{})]},e)})}),(0,i.jsx)(a.__experimentalConfirmDialog,{isOpen:y,onConfirm:()=>{x(!1),v&&("file"===v.type&&v.childId?(e=>{const r=h?.[e];if(!r||!r.child_id)return b((0,t.__)("Error: Cannot delete file, missing attachment ID.")),void console.error("Cannot delete file: Missing child_id for format",e);w(e),n()({path:`/wp/v2/media/${r.child_id}?force=true`,method:"DELETE"}).then(()=>{b((0,t.__)("File deleted successfully.")),O()}).catch(e=>{console.error("File delete failed:",e),b((0,t.sprintf)((0,t.__)("Error deleting file: %s"),e.message)),O()}).finally(()=>{w(null)})})(v.formatId):"job"===v.type&&v.jobId&&P(v.jobId)),j(null)},onCancel:()=>{j(null),x(!1)},children:v?"file"===v.type?(0,t.sprintf)((0,t.__)("You are about to permanently delete the encoded %s video file from your site. This action cannot be undone."),v.name):"job"===v.type?(0,t.sprintf)((0,t.__)("You are about to permanently delete the encoding job for the %s video. This will also delete the encoded video file if it exists (if created by this job and not yet a separate attachment). This action cannot be undone."),v.name):void 0:""})]}):(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.Spinner,{})})}),p&&h&&(0,i.jsxs)(a.PanelRow,{children:[(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>{N(!0);const e=Object.entries(h).filter(([e,t])=>t.checked&&t.is_available&&"queued"!==t.status&&"processing"!==t.status&&"completed"!==t.status).reduce((e,[t,r])=>(e[t]=!0,e),{});n()({path:T+"/"+d,method:"PUT",data:{url:u,formats:e,parent_id:s?.record?.post}}).then(e=>{console.log(e),b((()=>{const r=e?.enqueue_data?.encode_list?new Intl.ListFormat(L?.language?L.language.replace("_","-"):"en-US",{style:"long",type:"conjunction"}).format(Object.values(e?.enqueue_data?.encode_list)):"";if(0==e?.enqueue_data?.new_queue_position){const n=e?.enqueue_data?.existing_queue_position;return"[]"!==!JSON.stringify(e?.enqueue_data?.encode_list)?(0,t.sprintf)((0,t.__)("%1$s updated in existing queue entry in position %2$s."),r,n):(0,t.sprintf)((0,t.__)("Video is already %1$s in the queue."),n)}if(1===e?.enqueue_data?.new_queue_position)return(0,t.__)("Starting...");{const n=e?.enqueue_data?.new_queue_position;return(0,t.sprintf)((0,t.__)("%1$s added to queue in position %2$s."),r,n)}})()),N(!1),O()}).catch(e=>{console.error(e),b((0,t.sprintf)((0,t.__)("Error enqueueing: %s"),e.message)),N(!1),O()})},title:z()?R?(0,t.__)("Loading..."):(0,t.__)("Encode selected formats"):(0,t.__)("Select formats to encode"),text:(0,t.__)("Encode"),disabled:V}),R&&(0,i.jsx)(a.Spinner,{}),g&&(0,i.jsx)("span",{className:"videopack-encode-message",children:g})]})]})})})},g=({attachmentAttributes:e})=>{const{id:t}=e,[r,c]=(0,o.useState)(),[l,d]=(0,o.useState)(),u=isNaN(t)?null:(0,s.useEntityRecord)("postType","attachment",t);return(0,o.useEffect)(()=>(console.log("Attachment component mounted."),n()({path:"/videopack/v1/settings",method:"GET"}).then(e=>{c(e)}),()=>console.log("Component unmounted!")),[]),(0,o.useEffect)(()=>{d({id:t,numberofthumbs:e?.meta?.["_kgvid-meta"]?.numberofthumbs||r?.numberofthumbs,src:e?.url,poster:e?.meta?.["_kgflashmediaplayer-poster"]||e?.image?.src,poster_id:e?.meta?.["_kgflashmediaplayer-poster-id"]})},[r]),l&&u.hasResolved&&r?(0,i.jsxs)("div",{className:"videopack-attachment-details",children:[(0,i.jsx)(h,{setAttributes:d,attributes:l,attachmentRecord:u,options:r}),(0,i.jsx)(f,{setAttributes:d,attributes:l,attachmentRecord:u,options:r})]}):(0,i.jsx)(a.Spinner,{})};jQuery(function(){if(wp.media&&wp.media.view&&wp.media.view.Attachment.Details){var e=wp.media.view.Attachment.Details;wp.media.view.Attachment.Details=e.extend({render:function(){if(this.videopackReactRootInstance&&(ReactDOM.unmountComponentAtNode(this.videopackReactRootInstance),this.videopackReactRootInstance=null,console.log("unmount")),e.prototype.render.apply(this,arguments),"video"===this.model.attributes.type||"gif"===this.model.attributes.subtype&&this.model.attributes.meta?.["_kgvid-meta"]?.animated){var t=this.$el.find(".settings");if(t.length>0){const e=document.createElement("div");e.id="videopack-attachment-details-root",t.append(e);var r=this.$el.find("#videopack-attachment-details-root").get(0);r?(this.videopackReactRootInstance=ReactDOM.createRoot(r),this.videopackReactRootInstance.render((0,i.jsx)(g,{attachmentAttributes:this.model.attributes})),this.reactComponentMounted=!0):console.error("Failed to initialize the React root element.")}}},remove:function(){this.videopackReactRootInstance&&(this.videopackReactRootInstance.unmount(),this.videopackReactRootInstance=null),e.prototype.remove.call(this)}})}}())})();