(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.i18n,n=window.wp.apiFetch;var r=e.n(n);const a=window.wp.components,s=(window.wp.compose,window.wp.coreData),o=window.wp.element,i=window.ReactJSXRuntime,c=window.wp.blockEditor,l=window.wp.mediaUtils,d=window.wp.url,u=window.wp.primitives,m=(0,i.jsx)(u.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,i.jsx)(u.Path,{d:"M6.5 12.4L12 8l5.5 4.4-.9 1.2L12 10l-4.5 3.6-1-1.2z"})}),p=(0,i.jsx)(u.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,i.jsx)(u.Path,{d:"M17.5 11.6L12 16l-5.5-4.4.9-1.2L12 14l4.5-3.6 1 1.2z"})}),h=({setAttributes:e,attributes:n,attachmentRecord:s,options:u})=>{const{id:h,numberofthumbs:_,src:g,poster:v,poster_id:b}=n,f=(0,o.useRef)(),w=(0,o.useRef)(),k=(0,o.useRef)(),x=(0,o.useRef)(),[y,j]=(0,o.useState)(!1),[R,N]=(0,o.useState)(!1),[C,E]=(0,o.useState)(!1),[S,T]=(0,o.useState)([]),[I,L]=(0,o.useState)(!1),A="/videopack/v1/thumbs";(0,o.useEffect)(()=>{v||w.current.on("loadedmetadata",()=>{B("generate")})},[w.current]);const B=async(e="generate")=>{if(L(!0),u?.ffmpeg_exists&&!u?.browser_thumbnails){const t=[];let n=0,r=0;for(let a=1;a<=Number(_);a++){r=a+n;const s=await U(a,r,e);n++,console.log(s);let o={src:s.real_thumb_url,type:"ffmpeg",thumb_url:s.thumb_url};t.push(o),T([...t])}L(!1)}else O(e)},O=(0,o.useCallback)(async e=>{const t=Number(_),n=[],r=[...Array(t)].map((n,r)=>{let a=(r+1)/(t+1)*w.current.duration;if("random"===e){const e=Math.floor(Math.random()*(w.current.duration/t));a=Math.max(a-e,0)}return a}),a=()=>{let e;P().then(s=>{try{e={src:s.toDataURL(),type:"canvas"}}catch(e){return console.error(e),w.current.removeEventListener("timeupdate",a),void L(!1)}n.push(e),T([...n]),n.length===t?(w.current.removeEventListener("timeupdate",a),L(!1)):w.current.currentTime=r[n.length]}).catch(e=>{console.error("Error processing canvas:",e)})};w.current.addEventListener("timeupdate",a),w.current.currentTime=r[0]}),M=()=>{w.current?.paused?(w.current.play(),j(!0)):(w.current?.pause(),j(!1))},D=()=>{w.current.pause(),j(!1)};(0,o.useEffect)(()=>{const e=()=>{E(w.current.currentTime)};return w.current?.addEventListener("timeupdate",e),()=>{w.current?.removeEventListener("timeupdate",e)}},[]);const P=async()=>{const e=document.createElement("canvas");if(e.width=w.current.videoWidth,e.height=w.current.videoHeight,e.getContext("2d").drawImage(w.current,0,0,e.width,e.height),!u?.ffmpeg_thumb_watermark?.url)return e;try{const n=function(e){return new Promise(async(n,r)=>{try{u?.ffmpeg_thumb_watermark?.url||r(new Error("No thumbnail watermark set"));const a=e.getContext("2d"),s=new Image,{url:o,scale:i,align:c,x:l,valign:d,y:m}=u.ffmpeg_thumb_watermark;s.crossOrigin="Anonymous",s.src=o,s.onload=()=>{const o=e.width,u=e.height,p=o*i/100,h=u*i/100,_=o*l/100,g=u*m/100;let v,b;switch(c){case"left":v=_;break;case"center":v=(o-p)/2+_;break;case"right":v=o-p-_;break;default:return void r(new Error((0,t.__)("Invalid horizontal alignment provided")))}switch(d){case"top":b=g;break;case"center":b=(u-h)/2+g;break;case"bottom":b=u-h-g;break;default:return void r(new Error((0,t.__)("Invalid vertical alignment provided")))}a.drawImage(s,v,b,p,h),n(e)},s.onerror=()=>{r(new Error((0,t.__)("Failed to load watermark image")))}}catch(e){r(e)}})}(e);return n}catch(e){console.error("Error drawing watermark:",e)}},q=async(e,n)=>{const r=(0,d.getFilename)(g),a=r.substring(0,r.lastIndexOf("."))||r;try{const r=(e=>{const t=atob(e.split(",")[1]),n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return n})(e),o=new File([r],a+"_thumb"+(n+1)+".png",{type:"image/png"});L(!0);const i=await(s={filesList:[o],allowedTypes:["image/png"],title:a+" "+(0,t.__)("thumbnail")+" "+(n+1)},new Promise((e,t)=>{(0,l.uploadMedia)({...s,onFileChange:t=>{const n=t[0];n&&n.hasOwnProperty("id")&&e(n)},onError:e=>{t(e)}})}));F(i.url,i.id),L(!1)}catch(e){console.error((0,t.__)("Upload error:"),e),createErrorNotice(e,{type:"snackbar"})}var s},F=(t,n)=>{e({poster:t,poster_id:n}),T([]),s.edit({featured_media:Number(n),meta:{"_kgflashmediaplayer-poster":t,"_kgflashmediaplayer-poster-id":Number(n)}}).then(e=>{s.save().then(e=>{console.log(s)})}).catch(e=>{console.error(e)})},U=async(e,t,n)=>{try{const a=(0,d.addQueryArgs)(A,{movieurl:g,numberofthumbs:_,thumbnumber:e,thumbnumberplusincreaser:t,attachmentID:h,generate_button:n,thumbtimecode:0,dofirstframe:!1,poster:v});return await r()({path:a})}catch(e){console.error(e)}},$=e=>{switch(e.stopImmediatePropagation(),e.code){case"Space":M();break;case"ArrowLeft":D(),w.current.currentTime=w.current.currentTime-.042;break;case"ArrowRight":D(),w.current.currentTime=w.current.currentTime+.042;break;case"KeyJ":y&&(w.current.playbackRate=Math.max(0,w.current.playbackRate-1));break;case"KeyK":D();break;case"KeyL":y&&(w.current.playbackRate=w.current.playbackRate+1),w.current.play(),j(!0);break;default:return}e.preventDefault()};return(0,i.jsx)("div",{className:"videopack-thumbnail-generator",children:(0,i.jsxs)(a.PanelBody,{title:(0,t.__)("Thumbnails"),children:[v&&(0,i.jsx)("img",{className:"videopack-current-thumbnail",src:v,ref:k}),(0,i.jsxs)(a.BaseControl,{className:"editor-video-poster-control",children:[(0,i.jsx)(a.BaseControl.VisualLabel,{children:(0,t.__)("Video Thumbnail")}),(0,i.jsx)(c.MediaUpload,{title:(0,t.__)("Select video thumbnail"),onSelect:function(t){e({poster:t.url,poster_id:Number(t.id)})},allowedTypes:["image"],render:({open:e})=>(0,i.jsx)(a.Button,{variant:"secondary",onClick:e,ref:x,children:v?(0,t.__)("Replace"):(0,t.__)("Select")})}),!!v&&(0,i.jsx)(a.Button,{onClick:function(){e({poster:void 0}),x.current.focus()},variant:"tertiary",children:(0,t.__)("Remove")})]}),(0,i.jsx)(a.TextControl,{value:_,onChange:t=>{e(t?{numberofthumbs:Number(t)}:{numberofthumbs:""})},className:"videopack-numberofthumbs",disabled:I}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>B("generate"),className:"videopack-generate",disabled:I,children:(0,t.__)("Generate")}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>B("random"),className:"videopack-generate",disabled:I,children:(0,t.__)("Random")}),S.length>0&&(0,i.jsx)("div",{className:"videopack-thumbnail-holder"+(I?" disabled":""),children:S.map((e,n)=>(0,i.jsxs)("div",{className:"videopack-thumbnail",onClick:t=>{((e,t,n)=>{e.currentTarget.classList.add("saving"),L(!0),"ffmpeg"===t.type?(async(e,t)=>{try{const n=await r()({path:A,method:"PUT",data:{post_id:h,thumburl:e,index:t}});F(n.thumb_url,n.thumb_id)}catch(e){console.error(e)}})(t.thumb_url,n):q(t.src,n)})(t,e,n)},children:[(0,i.jsx)("img",{src:e.src,alt:`Thumbnail ${n+1}`,title:(0,t.__)("Save and set thumbnail")}),(0,i.jsx)(a.Spinner,{})]},n))}),(0,i.jsxs)("div",{className:"components-panel__body videopack-thumb-video "+(R?"is-opened":""),children:[(0,i.jsx)("h2",{className:"components-panel__body-title",children:(0,i.jsxs)("button",{className:"components-button components-panel__body-toggle",type:"button",onClick:e=>{e.preventDefault();const t=!R;N(t),t&&f.current?(f.current.focus(),f.current.addEventListener("keydown",$)):f.current.addEventListener("keydown",$)},"aria-expanded":R,children:[(0,i.jsx)("span",{"aria-hidden":"true",children:(0,i.jsx)(a.Icon,{className:"components-panel__arrow",icon:R?m:p})}),(0,t.__)("Choose From Video")]})}),(0,i.jsxs)("div",{className:"videopack-thumb-video-panel",tabIndex:0,ref:f,children:[(0,i.jsx)("video",{src:g,ref:w,muted:!0,preload:"metadata",onClick:M}),(0,i.jsx)(a.Button,{className:"videopack-play-pause",onClick:M,children:(0,i.jsx)(a.Dashicon,{icon:y?"controls-pause":"controls-play"})}),!isNaN(w.current?.duration)&&(0,i.jsx)(a.RangeControl,{__nextHasNoMarginBottom:!0,min:0,max:w.current.duration,step:"any",initialPosition:0,value:w.current.currentTime,onChange:e=>{w.current.currentTime=e,E(e)},className:"videopack-thumbvideo-slider",type:"slider"}),(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>{L(!0);const e=P();q(e.toDataURL(),0)},disabled:I,children:(0,t.__)("Use this frame")})]})]})]})})},_=window.wp.data,g=({setAttributes:e,attributes:n,attachmentRecord:s,options:l})=>{const{id:d,src:u,height:m}=n,{ffmpeg_exists:p}=l,[h,g]=(0,o.useState)(),[v,b]=(0,o.useState)(),[f,w]=(0,o.useState)(),[k,x]=(0,o.useState)(!1),[y,j]=(0,o.useState)(!1),R=(0,o.useRef)(null),N=(0,o.useRef)(null);(0,o.useEffect)(()=>{r()({path:"/videopack/v1/formats/"+d}).then(e=>{g(e),console.log(e)})},[d]);const C=e=>!!(!1===e||null===e||Array.isArray(e)&&0===e.length||"object"==typeof e&&0===Object.keys(e).length),E=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const a of n)if(!r.includes(a)||!E(e[a],t[a]))return!1;return!0},S=(0,_.useSelect)(e=>e("core").getSite(),[]),T=()=>!!h&&Object.values(h).some(e=>e.hasOwnProperty("encoding_now")&&e.encoding_now),I=()=>{if(console.log("progress"),T()){const e=Object.entries(h).reduce((e,[t,n])=>{if(C(n.progress))e[t]=n;else{const r=n.progress.current_seconds+parseInt(n.progress.fps)/30;let a=Math.round(n.progress.current_seconds/parseInt(n.progress.duration)*100);a>100&&(a=100),0!=a&&(n.progress.elapsed=n.progress.elapsed+1,isNaN(n.progress.remaining)||(n.progress.remaining>0?n.progress.remaining--:n.progress.remaing=0)),e[t]={...n,progress:{...n.progress,current_seconds:r,elapsed:n.progress.elapsed,percent_done:a,remaining:n.progress.remaining}}}return e},{});g(e)}},L=()=>{console.log("update"),u&&d&&r()({path:"/videopack/v1/formats/"+d,method:"GET"}).then(e=>{E(h,e)||g(e)})};(0,o.useEffect)(()=>(R.current=setTimeout(L,5e3),T()?(null===N.current&&(N.current=setInterval(I,1e3)),()=>{null!==N.current&&(clearInterval(N.current),N.current=null),null!==R.current&&(clearTimeout(R.current),R.current=null)}):(clearInterval(N.current),void(N.current=null))),[h]);const A=()=>!!h&&Object.values(h).some(e=>!1===e.exists),B=e=>{console.log("select")},O=e=>!(!h||h[e].exists&&!h[e].was_picked||h[e].encoding_now),M=e=>{const t=e=>e.toString().padStart(2,"0"),n=Math.floor(e/3600),r=Math.floor(e%3600/60),a=e%60;return(n>0?t(n)+":":"")+t(r)+":"+t(a)},D=({format:e})=>{if(!C(h[e]?.progress)){const n=(0,t.sprintf)((0,t.__)("%d%%"),h[e].progress.percent_done),r=()=>{console.log("cancel")};return(0,i.jsxs)("div",{className:"videopack-encode-progress",children:[(0,i.jsx)("div",{className:"videopack-meter",children:(0,i.jsx)("div",{className:"videopack-meter-bar",style:{width:n},children:(0,i.jsx)("div",{className:"videopack-meter-text",children:h[e].progress.percent_done>20&&n})})}),(0,i.jsx)(a.Button,{onClick:r,variant:"secondary",isDestructive:!0,size:"small",children:(0,t.__)("Cancel")}),(0,i.jsxs)("div",{className:"videopack-encode-progress-small-text",children:[(0,i.jsx)("span",{children:(0,t.__)("Elapsed:")+" "+M(h[e].progress.elapsed)}),(0,i.jsx)("span",{children:(0,t.__)("Remaining:")+" "+M(h[e].progress.remaining)}),(0,i.jsx)("span",{children:(0,t.__)("fps:")+" "+h[e].progress.fps})]})]})}return null};return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.PanelBody,{title:(0,t.__)("Additional Formats"),children:(0,i.jsxs)(c.MediaUploadCheck,{children:[(0,i.jsx)(a.PanelRow,{children:h?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("ul",{className:"videopack-formats-list"+(p?"":" no-ffmpeg"),children:Object.keys(h).map(e=>(0,i.jsxs)("li",{children:[p&&!h[e].exists?(0,i.jsx)(a.CheckboxControl,{__nextHasNoMarginBottom:!0,className:"videopack-format",label:h[e].name,checked:h[e].checked,disabled:h[e].exists,onChange:t=>((e,t)=>{g(n=>(n[t].checked=e,{...n}));const n={...(s.meta?.["_kgvid-meta"]||{}).encode,[t]:!!e||"notchecked"};s.edit({meta:{"_kgvid-meta":{encode:n}}}).then(e=>{s.save().then(e=>{console.log(s)})}).catch(e=>{console.error(e)})})(t,e)}):(0,i.jsx)("span",{className:"videopack-format",children:h[e].name}),"notchecked"!=h[e].status&&(0,i.jsx)("span",{className:"videopack-format-status",children:h[e].status_l10n}),O(e)&&(0,i.jsx)(c.MediaUpload,{title:(0,t.sprintf)((0,t.__)("Choose %s From Library"),h[e].name),onSelect:B,allowedTypes:["video"],render:({open:n})=>(0,i.jsx)(a.Button,{variant:"secondary",onClick:n,className:"videopack-format-button",size:"small",title:(0,t.__)("Choose From Library"),children:h[e].was_picked?(0,t.__)("Replace"):(0,t.__)("Pick")})}),h[e].deletable&&(0,i.jsx)(a.Button,{isBusy:f&&f===e,onClick:()=>(e=>{w(e),x(!0)})(e),variant:"link",text:(0,t.__)("Delete Permanently"),isDestructive:!0}),"encoding"===h[e].status&&(0,i.jsx)(D,{format:e}),(0,i.jsx)(a.__experimentalDivider,{})]},e))}),(0,i.jsx)(a.__experimentalConfirmDialog,{isOpen:k,onConfirm:()=>{var e;x(!1),e=f,r()({path:`/wp/v2/media/${h[e].child_id}?force=true`,method:"DELETE"}).then(()=>{g(n=>(n[e]={...n[e],exists:!1,status:"deleted",status_l10n:(0,t.__)("deleted"),deletable:!1,checked:!0},{...n}))}).catch(e=>{console.error(e)}),w(null)},onCancel:()=>{w(null),x(!1)},children:(0,t.sprintf)((0,t.__)("You are about to permanently delete the encoded %s video from your site. This action cannot be undone."),h?.[f]?.name)})]}):(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.Spinner,{})})}),p&&h&&(0,i.jsxs)(a.PanelRow,{children:[(0,i.jsx)(a.Button,{variant:"secondary",onClick:()=>{j(!0);const e=Object.entries(h).reduce((e,[t,n])=>(e[t]=!!n.checked,e),{});r()({path:"/videopack/v1/queue/"+d,method:"PUT",data:{movieurl:u,encodeformats:e,parent_id:s?.record?.post}}).then(e=>{console.log(e),b((()=>{const n=e?.enqueue_data?.encode_list?new Intl.ListFormat(S?.language?S.language.replace("_","-"):"en-US",{style:"long",type:"conjunction"}).format(Object.values(e?.enqueue_data?.encode_list)):"";if(0==e?.enqueue_data?.new_queue_position){const r=e?.enqueue_data?.existing_queue_position;return"[]"!==!JSON.stringify(e?.enqueue_data?.encode_list)?(0,t.sprintf)((0,t.__)("%1$s updated in existing queue entry in position %2$s."),n,r):(0,t.sprintf)((0,t.__)("Video is already %1$s in the queue."),r)}if(1===e?.enqueue_data?.new_queue_position)return(0,t.__)("Starting...");{const r=e?.enqueue_data?.new_queue_position;return(0,t.sprintf)((0,t.__)("%1$s added to queue in position %2$s."),n,r)}})()),j(!1),L()}).catch(e=>{console.error(e)})},title:A()?y?(0,t.__)("Loading..."):(0,t.__)("Encode selected formats"):(0,t.__)("Nothing to encode"),text:(0,t.__)("Encode"),disabled:!A()}),y&&(0,i.jsx)(a.Spinner,{}),v&&(0,i.jsx)("span",{className:"videopack-encode-message",children:v})]})]})})})},v=({attachmentAttributes:e})=>{const{id:t}=e,[n,c]=(0,o.useState)(),[l,d]=(0,o.useState)(),u=isNaN(t)?null:(0,s.useEntityRecord)("postType","attachment",t);return(0,o.useEffect)(()=>(console.log("Attachment component mounted."),r()({path:"/videopack/v1/settings",method:"GET"}).then(e=>{c(e)}),()=>console.log("Component unmounted!")),[]),(0,o.useEffect)(()=>{d({id:t,numberofthumbs:e?.meta?.["_kgvid-meta"]?.numberofthumbs||n?.numberofthumbs,src:e?.url,poster:e?.meta?.["_kgflashmediaplayer-poster"]||e?.image?.src,poster_id:e?.meta?.["_kgflashmediaplayer-poster-id"]})},[n]),l&&u.hasResolved&&n?(0,i.jsxs)("div",{className:"videopack-attachment-details",children:[(0,i.jsx)(h,{setAttributes:d,attributes:l,attachmentRecord:u,options:n}),(0,i.jsx)(g,{setAttributes:d,attributes:l,attachmentRecord:u,options:n})]}):(0,i.jsx)(a.Spinner,{})};jQuery(function(){if(wp.media&&wp.media.view&&wp.media.view.Attachment.Details){var e=wp.media.view.Attachment.Details;wp.media.view.Attachment.Details=e.extend({render:function(){if(this.videopackReactRootInstance&&(ReactDOM.unmountComponentAtNode(this.videopackReactRootInstance),this.videopackReactRootInstance=null,console.log("unmount")),e.prototype.render.apply(this,arguments),"video"===this.model.attributes.type||"gif"===this.model.attributes.subtype&&this.model.attributes.meta?.["_kgvid-meta"]?.animated){var t=this.$el.find(".settings");if(t.length>0){const e=document.createElement("div");e.id="videopack-attachment-details-root",t.append(e);var n=this.$el.find("#videopack-attachment-details-root").get(0);n?(this.videopackReactRootInstance=ReactDOM.createRoot(n),this.videopackReactRootInstance.render((0,i.jsx)(v,{attachmentAttributes:this.model.attributes})),this.reactComponentMounted=!0):console.error("Failed to initialize the React root element.")}}},remove:function(){this.videopackReactRootInstance&&(this.videopackReactRootInstance.unmount(),this.videopackReactRootInstance=null),e.prototype.remove.call(this)}})}}())})();